# azure-pipelines.yml - Aşama 3: Akıllı Monorepo Mantığı

# Tetikleyici artık tüm ana dalı dinliyor.
# Sadece belirli klasörlerdeki değişiklikler build'i tetikleyecek.
trigger:
  branches:
    include:
      - main
  paths:
    include:
      - 'user_service/*'
      - 'ticket_service/*'
      - 'auth_service/*'
      - 'frontend/*'
    # README gibi dosyalardaki değişiklikler için pipeline'ı boşuna çalıştırma.
    exclude:
      - README.md

pool:
  name: 'Default'

variables:
  harborRepo: 'harbor.cloudpro.com.tr/helpdesk' 
  imageTag: '$(Build.BuildId)'
  k8sNamespace: 'ado-agents'
  gitRepoUrl: 'https://dev.azure.com/umutcelik0234/HelpDesk_App/_git/helpdesk-app-src'
  kanikoTemplateFile: 'kaniko-pod-template.yaml'
  kanikoFinalFile: '$(Build.ArtifactStagingDirectory)/kaniko-pod-final'

stages:
- stage: Build_Services
  displayName: 'Build and Push Service Images'
  jobs:
  # YENİ İŞ: Değişiklikleri algılayan ilk işimiz.
  - job: DetectChanges
    displayName: '1. Detect Changed Services'
    steps:
      # Git geçmişinin tamamını çekmek için fetchDepth: 0 ekliyoruz.
      - checkout: self
        fetchDepth: 0
      - task: Bash@3
        # Bu adıma bir isim veriyoruz ki, çıktısına referans verebilelim.
        name: detect_changes_step 
        displayName: 'Run change detection script'
        script: |
          chmod +x templates/detect-changes.sh
          ./templates/detect-changes.sh

  # Her servis için build işi artık 'DetectChanges' işine bağımlı ve koşullu.
  - template: templates/build-service-job.yml
    parameters:
      serviceName: 'user_service'
      dependsOn: DetectChanges
      # 'DetectChanges' işinin 'detect_changes_step' adımının ürettiği 
      # 'USER_SERVICE_CHANGED' değişkeni 'true' ise bu iş çalışır.
      condition: eq(dependencies.DetectChanges.outputs['detect_changes_step.USER_SERVICE_CHANGED'], 'true')

  - template: templates/build-service-job.yml
    parameters:
      serviceName: 'ticket_service'
      dependsOn: DetectChanges
      condition: eq(dependencies.DetectChanges.outputs['detect_changes_step.TICKET_SERVICE_CHANGED'], 'true')

  - template: templates/build-service-job.yml
    parameters:
      serviceName: 'auth_service'
      dependsOn: DetectChanges
      condition: eq(dependencies.DetectChanges.outputs['detect_changes_step.AUTH_SERVICE_CHANGED'], 'true')

  - template: templates/build-service-job.yml
    parameters:
      serviceName: 'frontend'
      dependsOn: DetectChanges
      condition: eq(dependencies.DetectChanges.outputs['detect_changes_step.FRONTEND_CHANGED'], 'true')