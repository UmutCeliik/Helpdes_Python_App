# templates/sca-pod-template.yaml

apiVersion: v1
kind: Pod
metadata:
  name: __POD_NAME__
spec:
  volumes:
  - name: workspace
    emptyDir: {}

  initContainers:
  - name: git-checkout
    image: alpine/git:latest
    env:
    - name: AZP_TOKEN
      value: "__AZP_TOKEN__"
    - name: GIT_REPO_URL
      value: "__CONTEXT__"
    command: ["/bin/sh", "-c"]
    args:
    - |
      set -e
      cd /workspace
      CLONE_URL=$(echo $GIT_REPO_URL | sed "s,https://,https://$AZP_TOKEN@,")
      git clone $CLONE_URL .
    volumeMounts:
    - name: workspace
      mountPath: /workspace
      
  containers:
  - name: scanner
    image: __SCANNER_IMAGE__
    workingDir: /workspace/__CONTEXT_SUB_PATH__
    command: ["/bin/sh", "-c"]
    
    env:
    - name: PIP_INDEX_URL
      value: "__NEXUS_URL_WITH_CREDS__"
    - name: PIP_TRUSTED_HOST
      value: "__NEXUS_HOST__"
    - name: SERVICE_TYPE
      value: "__SERVICE_TYPE__"
    - name: NPM_CONFIG_REGISTRY
      value: "http://nexus-repository-manager.nexus:8081/repository/npm-group/"
    args:
    - |
      set -e
      echo "SCA Scan starting for service type: $SERVICE_TYPE"
      if [ "$SERVICE_TYPE" = "frontend" ]; then
        echo ">>> SCA: Using npm registry: $NPM_CONFIG_REGISTRY"
        echo "Running Node.js SCA Scan in $(pwd)..."
        npm install 
        npm audit --audit-level=moderate || (echo "npm audit found vulnerabilities" && exit 1)
      else
        echo "Running Python SCA Scan..."
        python -m pip install -r requirements.txt
        python -m pip install pip-audit
        # --- DÜZELTME BURADA ---
        # --fail-on high yerine sadece komutu çalıştırmak yeterli.
        # Herhangi bir zafiyet bulursa "set -e" sayesinde script hata verecektir.
        pip-audit
      fi
    
    volumeMounts:
    - name: workspace
      mountPath: /workspace
      
  restartPolicy: Never