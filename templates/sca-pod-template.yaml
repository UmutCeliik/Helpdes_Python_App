# templates/sca-pod-template.yaml
# Dosya yapısını loglamak için hata ayıklama komutları eklendi.

apiVersion: v1
kind: Pod
metadata:
  name: __POD_NAME__
spec:
  volumes:
  - name: workspace
    emptyDir: {}

  initContainers:
  - name: git-checkout
    image: alpine/git:latest
    env:
    - name: AZP_TOKEN
      value: "__AZP_TOKEN__"
    - name: GIT_REPO_URL
      value: "__CONTEXT__"
    command: ["/bin/sh", "-c"]
    args:
    - |
      set -e
      cd /workspace
      CLONE_URL=$(echo $GIT_REPO_URL | sed "s,https://,https://$AZP_TOKEN@,")
      git clone $CLONE_URL .
    volumeMounts:
    - name: workspace
      mountPath: /workspace

  # containers:
  # - name: scanner
  #   image: __SCANNER_IMAGE__
  #   workingDir: /workspace/__CONTEXT_SUB_PATH__
  #   command: ["/bin/sh", "-c"]
  #   args:
  #   - |
  #     set -e
  #     # echo "--- DEBUG: Contents of /workspace after git-checkout ---"
  #     # ls -lR /workspace # /workspace altındaki her şeyi recursive listeler
  #     # echo "--------------------------------------------------------"

  #     echo "SCA Scan starting for service type: $SERVICE_TYPE"
  #     if [ "$SERVICE_TYPE" = "frontend" ]; then
  #       echo "Running Node.js SCA Scan in $(pwd)..."
  #       npm install
  #       npm audit --audit-level=moderate || (echo "npm audit found vulnerabilities" && exit 1)
  #     else
  #       echo "Running Python SCA Scan..."
  #       python -m pip install -r requirements.txt
  #       python -m pip install pip-audit
  #       pip-audit
  #     fi

  containers:
  - name: scanner
    image: __SCANNER_IMAGE__
    workingDir: /workspace/__CONTEXT_SUB_PATH__
    command: ["/bin/sh", "-c"]
    args:
    - |
      set -e
      echo "--- Debugging DNS in Pod ---"
      echo "Current working directory: $(pwd)"
      echo "Content of /etc/resolv.conf:"
      cat /etc/resolv.conf

      # dnsutils (nslookup, dig) kurmaya çalışalım
      # SonarScanner CLI imajı genellikle Debian tabanlıdır.
      echo "Attempting to install dnsutils..."
      apt-get update && apt-get install -y dnsutils || \
      # Eğer Debian değilse ve Alpine ise:
      apk add --no-cache bind-tools || \
      echo "WARNING: Could not install dnsutils/bind-tools. DNS lookup tests might fail."

      echo "DNS Lookup for sonarqube.sonarqube.svc.cluster.local (Internal Cluster DNS Check):"
      nslookup sonarqube.sonarqube.svc.cluster.local || echo "nslookup command failed. DNS resolution issue might persist."
      echo "DNS Lookup for kubernetes.default.svc.cluster.local (Kubernetes API - Health Check):"
      nslookup kubernetes.default.svc.cluster.local || echo "nslookup command failed for Kubernetes API. General DNS issue."
      echo "--- End Debugging DNS ---"
      
      echo "Starting SonarScanner with custom SSL truststore..."
      
      sonar-scanner \
        -Dsonar.host.url=__SONAR_URL__ \
        -Dsonar.login=__SONAR_TOKEN__ \
        -Dsonar.projectKey=__PROJECT_KEY__ \
        -Dsonar.projectName=__PROJECT_KEY__ \
        -Dsonar.sources=. \
        -Dsonar.scm.disabled=true
    
    env:
    - name: SERVICE_TYPE
      value: "__SERVICE_TYPE__"

    volumeMounts:
    - name: workspace
      mountPath: /workspace
      
  restartPolicy: Never